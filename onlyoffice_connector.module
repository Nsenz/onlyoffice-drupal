<?php

/**
 * @file
 * Primary module hooks for ONLYOFFICE Connector module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\onlyoffice_connector\OnlyofficeDocumentHelper;
use Drupal\onlyoffice_connector\OnlyofficeAppConfig;
use Drupal\Core\Url;

/**
 * Implements hook_theme().
 */
function onlyoffice_connector_theme($existing, $type, $theme, $path) {
  return [
    'onlyoffice_editor' => [
      'variables' => [
          'filename' => 'noname',
          'doc_type' => 'docx',
          'doc_server_url' => 'http://127.0.0.1/',
          'config' => '{}',
          'error' => null
        ],
    ],
  ];
}

/**
 * Implements hook_entity_operation().
 */
function onlyoffice_connector_entity_operation(EntityInterface $entity) {
  if ($entity->getEntityTypeId() != "media") {
    return null;
  }
  /** @var \Drupal\media\Entity\Media $media */
  $media = $entity;

  if ($media->getSource()->getPluginId() != "file"){
    return null;
  }

  $account = \Drupal::currentUser()->getAccount();

  if (!$media->access("view", $account)) {
    return null;
  }

  $file = $media->get(OnlyofficeDocumentHelper::getSourceFieldName($media))->entity;
  $extension = OnlyofficeDocumentHelper::getExtension($file->getFilename());

  if (OnlyofficeDocumentHelper::getDocumentType($extension) == null) {
    return null;
  }

  $title = t("View in ONLYOFFICE");

  if (OnlyofficeDocumentHelper::isEditable($extension) && $media->access("update", $account)) {
    $title =  t("Edit in ONLYOFFICE");
  }

  if (OnlyofficeDocumentHelper::isFillForms($extension) && $media->access("update", $account)) {
    $title =  t("Fill in form in ONLYOFFICE");
  }

  $route_name = "onlyoffice_connector.editor";
  $route_parameters = [
    'media' => $media->id(),
  ];

  return [
    'onlyoffice' => [
      'title' => $title,
      'weight' => 50,
      'url' => Url::fromRoute($route_name, $route_parameters),
    ],
  ];
}

/**
 * Implements hook_library_info_build().
 */
function onlyoffice_connector_library_info_build() {

  $options = \Drupal::config('onlyoffice_connector.settings');

  if ($doc_server_url = $options->get('doc_server_url')) {
    $api_url = $doc_server_url . OnlyofficeAppConfig::getDocServiceApiUrl();
    return [
      'onlyoffice.api' => [
        'js' => [
          $api_url => [],
        ],
      ],
    ];
  }
}
